<!doctype html>
<html lang="en">

<head>
    <title>Overview report</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="../assets/bootstrap/css/bootstrap.min.css" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>   
    <script src="/wb-app-03/assets/chartjs/Chart.js"></script>
    <script src="/wb-app-03/js/main.js"></script>
    <link href="../assets/icon/open-iconic/font/css/open-iconic-bootstrap.css" rel="stylesheet">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <style>
        .vl {
          border-left: 6px solid green;
          
        }
        </style>
</head>

<body style="display:none">
    <div id="navbar-main">
    </div>
    <div class="container-fluid">
        <div class="container-fluid mt-3">
            <div class="row">
                <div class="col-md-6 float-left">                    
                    <span class="mx-md-3 font-weight-bold">
                        <span class="oi oi-calendar"></span>
                        <span>Date : </span>
                        <span id="current-date" class="text-primary"></span>
                    </span>                    
                </div>                
            </div>            
        </div>
        <!--piechart-->             
        <div class="row mt-3 mx-3">
            <div class="col-3 text-center">                
                <p class="h4">Total incomes: <span id="total-income" class="text-primary font-weight-bold">10,000</span></p>
                <canvas id="pie-summary">                    
                </canvas>                
            </div>            
            <div class="col-3 text-center">                
                <p class="h4">Bev. incomes: <span id="bev-income" class="text-primary">10,000</span></p>
                <canvas id="pie-bev">                    
                </canvas>
            </div>
            <div class="col-3 text-center">
                <p class="h4">Dish incomes:<span id="dish-income" class="text-primary">10,000</span></p>
                <canvas id="pie-dish">                    
                </canvas>
            </div>
            <div class="col-3 text-center">
                <p class="h4">Snack incomes:<span id="snack-income" class="text-primary">10,000</span></p>
                <canvas id="pie-snack">                    
                </canvas>
            </div>
        </div> 

        <div class="dropdown-divider mt-4"></div>
        <!--ranking and timing-->
        <div class="row mt-3 mx-3">
            <div class="col-2">
                <p class="h4">Menu Ranking <span class="oi oi-signal text-primary"></span></p>
                <div id="menu-ranking">
                    <ul class="list-group">
                        <li class="list-group-item">1. First item</li>
                        <li class="list-group-item">2. Second item</li>
                        <li class="list-group-item">3. Third item</li>
                        <li class="list-group-item">4. First item</li>
                        <li class="list-group-item">5. Second item</li>
                        <li class="list-group-item">6. Third item</li>
                        <li class="list-group-item">7. First item</li>
                        <li class="list-group-item">8. Second item</li>
                        <li class="list-group-item">9. Third item</li>
                        <li class="list-group-item">10. Third item</li>
                      </ul>
                </div>
            </div>
            <div class="col-9">
                <p class="h4 text-center">Time Chart <span class="text-primary">06:00 - 20:00</span> </p>
                <canvas id="line-time" width="400" height="150" role="img">                    
                </canvas>
            </div>
            <div class="col-1 text-secondary text-right">   
                <br><br>             
                <p>peak-time</p>
                <p class="text-primary" id="peak-time">~06.00</p>                
            </div>
        </div>                 
    </div>
    <script>
        checkToken(sessionStorage.wbUsr, sessionStorage.wbToken);
        $('#navbar-main').load("../components/navbar-main/navbar-main.html #navbar-main");
        $.getScript("../components/navbar-main/navbar-main.js");

        var t_days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thur', 'Fri', 'Sat'];
        var t_n = new Date();
        var t_y = t_n.getFullYear();
        var t_m = t_n.getMonth() + 1;
        var t_d = t_n.getDate();
        var t_ds = t_n.getDay();
        var current_date = `${t_y}-${String("0" + t_m).slice(-2)}-${t_d}`;
        var metaGlobal = [];
        document.getElementById("current-date").innerHTML = t_days[t_ds] + " " + String("0" + t_m).slice(-2) + "/" + t_d + "/" + t_y;
        //-------------------------  
        $(document).ready(function () {
                console.log(`using service : /wb-app-03/ajax/service/reportService/reportService.php?date=${t_y + '-' + String("0" + t_m).slice(-2) + '-' + String("0" + t_d).slice(-2)}`);
                $.ajax({
                    url: `/wb-app-03/ajax/service/reportService/reportService.php?date=${t_y + '-' + String("0" + t_m).slice(-2)}`,
                    type: "GET",
                    beforeSend: function () {
                        console.log("request data...");
                    },
                    success: function (result) {
                        if (result != "0") {                                                     
                            //------cal dataset for each chart--------
                            var resJson = JSON.parse(result);
                            console.log(result); 
                            console.log(resJson);                                                        
                            //------cal meta data---------------------
                            //--incomes                            
                            let bevIncome = 0;
                            let dishIncome = 0;
                            let snackIncome = 0;
                            let bevType = [];
                            let dishType = [];
                            let snackType = [];
                            let bevAmount = 0;
                            let dishAmount = 0;
                            let snackAmount = 0;                            
                            resJson.forEach(el => {                                
                                switch (el.itemType) {
                                    case "1":   
                                    bevIncome += parseInt(el.cost) * parseInt(el.unit);  
                                    bevAmount += parseInt(el.unit);
                                    if(!bevType.includes(el.itemName)){
                                        bevType.push(el.itemName);                                        
                                    }                         
                                        break;
                                    case "2":       
                                    dishAmount += parseInt(el.unit); 
                                    dishIncome += parseInt(el.cost) * parseInt(el.unit);  
                                    if(!dishType.includes(el.itemName)){
                                        dishType.push(el.itemName);
                                    }                               
                                        break;
                                    case "3":   
                                    snackAmount += parseInt(el.unit);
                                    if(!snackType.includes(el.itemName)){
                                        snackType.push(el.itemName);
                                    }   
                                    snackIncome += parseInt(el.cost) * parseInt(el.unit);                                    
                                        break;
                                    default:
                                        break;
                                }                                
                            });
                            metaGlobal = {
                                "bevIncome" : bevIncome,
                                "dishIncome" : dishIncome,
                                "snackIncome" : snackIncome,
                                "totalIncome" : bevIncome + dishIncome + snackIncome,  
                                "bevType" : bevType,
                                "dishType" : dishType,
                                "snackType" : snackType,
                                "bevAmount" : bevAmount,
                                "dishAmount" : dishAmount,
                                "snackAmount" : snackAmount                              
                            };                                                                                                                            
                            //----------------------------------------
                            //----------------------------------------
                            //--summary-pie-chart--
                            var ctx = document.getElementById('pie-summary').getContext('2d');
                            var sumPieChart = new Chart(ctx, {
                                // The type of chart we want to create
                                type: 'pie',

                                // The data for our dataset
                                data: {
                                    labels: ['bev', 'dish', 'snack'],
                                    datasets: [{
                                        label: 'My First dataset',
                                        backgroundColor: colorGenerator([metaGlobal.bevAmount, metaGlobal.dishAmount, metaGlobal.snackAmount]),
                                        borderColor: 'rgb(42,77,105)',
                                        data: [metaGlobal.bevAmount, metaGlobal.dishAmount, metaGlobal.snackAmount]
                                    }]
                                },

                                // Configuration options go here
                                options: {
                                    legend: {
                                        position: 'bottom'
                                    }
                                }
                            });
                            document.getElementById("total-income").innerHTML = moneyFormat(metaGlobal.totalIncome.toString());

                            //--beverage-pie-chart--
                            let bevPieLabels = metaGlobal.bevType;
                            let bevPieDataset = [];
                            resJson.forEach(el => {                                
                                if(bevPieDataset[bevPieLabels.indexOf(el.itemName)] == null){
                                    bevPieDataset[bevPieLabels.indexOf(el.itemName)] = parseInt(el.unit);
                                }else{
                                    bevPieDataset[bevPieLabels.indexOf(el.itemName)] += parseInt(el.unit);
                                }
                            });                            
                            ctx = document.getElementById('pie-bev').getContext('2d');
                            var bevPieChart = new Chart(ctx, {
                                // The type of chart we want to create
                                type: 'doughnut',

                                // The data for our dataset
                                data: {
                                    labels: bevPieLabels,                                    
                                    datasets: [{
                                        label: 'My First dataset',                                        
                                        borderColor: 'rgb(42,77,105)',
                                        backgroundColor: colorGenerator(bevPieDataset),
                                        data: bevPieDataset
                                    }]                                    
                                },

                                // Configuration options go here
                                options: {
                                    legend: {
                                        display: false
                                    }
                                }
                            });
                            document.getElementById("bev-income").innerHTML = moneyFormat(metaGlobal.bevIncome.toString());

                            //--dishes-pie-chart--
                            let dishPieLabels = metaGlobal.dishType;
                            let dishPieDataset = [];
                            resJson.forEach(el => {                                
                                if(dishPieDataset[dishPieLabels.indexOf(el.itemName)] == null){
                                    dishPieDataset[dishPieLabels.indexOf(el.itemName)] = parseInt(el.unit);
                                }else{
                                    dishPieDataset[dishPieLabels.indexOf(el.itemName)] += parseInt(el.unit);
                                }
                            });                            
                            ctx = document.getElementById('pie-dish').getContext('2d');
                            var dishPieChart = new Chart(ctx, {
                                // The type of chart we want to create
                                type: 'doughnut',

                                // The data for our dataset
                                data: {
                                    labels: dishPieLabels,
                                    datasets: [{
                                        label: 'My First dataset',
                                        borderColor: 'rgb(42,77,105)',
                                        backgroundColor: colorGenerator(dishPieDataset),
                                        data: dishPieDataset
                                    }]
                                },

                                // Configuration options go here
                                options: {
                                    legend: {
                                        display: false
                                    }
                                }
                            });
                            document.getElementById("dish-income").innerHTML = moneyFormat(metaGlobal.dishIncome.toString());

                            //--snack-pie-chart--
                            let snackPieLabels = metaGlobal.snackType;
                            let snackPieDataset = [];
                            resJson.forEach(el => {                                
                                if(snackPieDataset[snackPieLabels.indexOf(el.itemName)] == null){
                                    snackPieDataset[snackPieLabels.indexOf(el.itemName)] = parseInt(el.unit);
                                }else{
                                    snackPieDataset[snackPieLabels.indexOf(el.itemName)] += parseInt(el.unit);
                                }
                            });
                            ctx = document.getElementById('pie-snack').getContext('2d');
                            var snackPieChart = new Chart(ctx, {
                                // The type of chart we want to create
                                type: 'doughnut',

                                // The data for our dataset
                                data: {
                                    labels: snackPieLabels,
                                    datasets: [{
                                        label: 'My First dataset',
                                        borderColor: 'rgb(42,77,105)',
                                        backgroundColor: colorGenerator(snackPieDataset),
                                        data: snackPieDataset
                                    }]
                                },

                                // Configuration options go here
                                options: {
                                    legend: {
                                        display: false
                                    }
                                }
                            });
                            document.getElementById("snack-income").innerHTML = moneyFormat(metaGlobal.snackIncome.toString());
                            
                            //--ranking----------                                                 
                            let allItemType = metaGlobal.bevType.concat(metaGlobal.dishType.concat(metaGlobal.snackType));
                            let allItemAmount = bevPieDataset.concat(dishPieDataset.concat(snackPieDataset));                            
                            let tmpAllItemAmount = String(allItemAmount);                            
                            let tmp = [];
                            let ranked = [];
                            tmpAllItemAmount = tmpAllItemAmount.split(",");                                                    
                            tmpAllItemAmount.forEach(el => {
                                if(!tmp.includes(parseInt(el))){
                                    tmp.push(parseInt(el));
                                }
                            });  
                            tmp.sort(function(a, b){return b - a});//sort tmp DESC                            
                            for (let i = 0; i < tmp.length; i++) {                                                         
                                for (let j = 0; j < allItemType.length; j++) {                                                                       
                                    if(allItemAmount[j] == tmp[i])
                                        ranked.push(`#${i+1}:${allItemType[j]} <span class='float-right text-primary'>${tmp[i]}</span>`);
                                }
                            }  
                            ranked = ranked.slice(0,10);      
                            //-show 10 rank-
                            let ul = document.createElement("UL");
                            ul.classList.add("list-group");
                            for (let i = 0; i < ranked.length; i++) {                                
                                let li = document.createElement("LI");
                                li.innerHTML = ranked[i];
                                li.classList.add("list-group-item");
                                ul.appendChild(li);
                            }
                            document.getElementById("menu-ranking").innerHTML = "";
                            document.getElementById("menu-ranking").appendChild(ul);
                           

                            //--time-line-chart--
                            
                            let timeChartRes = JSON.parse(result);
                            let checkTime = ['06:00', '06:30', '07:00', '07:30', '08:00', '08:30', '09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '12:00', '12:30', '13:00','13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00', '17:30', '18:00', '18:30', '19:00', '19:30', '20:00'];
                            let timeChartDataset = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];//6.00-20.00
                            let curHour = new Date();
                            curHour = curHour.getHours();//check from 6.00 -> curHour                            
                            timeChartRes.forEach(el => {
                                let tmpTime = el.addDate;
                                tmpTime = tmpTime.split(" ");
                                tmpTime = tmpTime[1];
                                tmpTime = tmpTime.slice(0,-3);
                                el.addDate = tmpTime;                                
                            });                                                           
                            for (let i = 0; i < checkTime.length; i++) {    //checkTime                                                           
                                for (let j = 0; j < timeChartRes.length; j++) {   //timeChartRes                                    
                                    if(checkTime[i] <= timeChartRes[j].addDate && timeChartRes[j].addDate < checkTime[i+1]){                                        
                                        timeChartDataset[i] += parseInt(timeChartRes[j].unit);                                        
                                    }                      
                                }                                
                            }
                            document.getElementById("peak-time").innerHTML = `~${checkTime[timeChartDataset.indexOf(Math.max.apply(Math, timeChartDataset))]}`;
                            ctx = document.getElementById('line-time').getContext('2d');
                            var timeLineChart = new Chart(ctx, {
                                // The type of chart we want to create
                                type: 'line',

                                // The data for our dataset
                                data: {
                                    labels: checkTime,
                                    datasets: [{
                                        backgroundColor: ['rgb(255, 255, 255)'],
                                        borderColor: 'rgb(4,123,255)',
                                        data: timeChartDataset
                                    }]
                                },

                                // Configuration options go here
                                options: {
                                    legend: {
                                        display: false
                                    },
                                    scales: {
                                        yAxes: [{
                                            scaleLabel: {
                                                display: true,
                                                labelString: 'Order in time ( Pieces ) '
                                            }
                                        }],
                                        xAxes: [{
                                            scaleLabel: {
                                                display: true,
                                                labelString: 'Time ( 30min/cell )'
                                            }
                                        }]
                                    }     
                                }
                            });
                        } else {
                            console.log("Error");
                        }                        
                    }                    
                });                
            });  
            function colorGenerator(dataset){//generate color for dataset and highligh maximum value                    
                    const colorPattern = ["rgb(224,224,224)", "rgb(245,245,245)"]; 
                    const colorMax = "rgb(4,123,255)";
                    let maxIndex = dataset.indexOf(Math.max.apply(Math, dataset));
                    let colors = [];                    
                    //generate color
                    let tmp = 0;
                    for (let i = 0; i < dataset.length; i++) {    
                        if(i == maxIndex){
                            colors.push(colorMax);
                            tmp = 1;
                        }else{
                            colors.push(colorPattern[((i+tmp)%2)]); 
                        }                                                      
                    }   
                    
                    return colors;              
            }   
            function moneyFormat(string){
                /** 
                * ! I/O is integer only
                */
                let arrChar = string.split('');
                arrChar.reverse();
                let groupRes = [];
                let tmp = [];
                for (let i = 0; i < arrChar.length; i++) {                                    
                    tmp.push(arrChar[i]);
                    if((i+1)%3 == 0 || i == (arrChar.length - 1)){
                        groupRes.push(tmp.reverse().join(""));
                        tmp = [];
                    }
                }
                groupRes.reverse();
                let stringRes = '';
                if(groupRes.length == 1){
                    stringRes = groupRes[0];
                }else{
                    groupRes.forEach(el => {
                        stringRes += `${el},`;
                    });
                    stringRes = stringRes.slice(0,-1);
                }
                return stringRes;
            }   
        //-------------------------                  
    </script>
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="../assets/bootstrap/js/bootstrap.js" crossorigin="anonymous"></script>
</body>

</html>
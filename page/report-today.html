<!doctype html>
<html lang="en">

<head>
    <title>Finished Jobs</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="../assets/bootstrap/css/bootstrap.min.css" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>   
    <script src="/wb-app-03/assets/chartjs/Chart.js"></script>
    <script src="/wb-app-03/js/main.js"></script>
    <link href="../assets/icon/open-iconic/font/css/open-iconic-bootstrap.css" rel="stylesheet">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
</head>

<body style="display:none">
    <div id="navbar-main">
    </div>
    <div class="container-fluid">
        <div class="container-fluid mt-3">
            <div class="row">
                <div class="col-md-6 float-left">                    
                    <span class="mx-md-3 font-weight-bold">
                        <span class="oi oi-calendar"></span>
                        <span>Date : </span>
                        <span id="current-date" class="text-primary"></span>
                    </span>                    
                </div>                
            </div>            
        </div>
        <!--piechart-->
        <div class="row mt-3 mx-3">
            <div class="col-3 text-center">                
                <p>total incomes: <span id="total-income">10,000</span></p>
                <canvas id="pie-summary">                    
                </canvas>
            </div>
            <div class="col-3 text-center">
                <p>bev. incomes: <span id="bev-income">10,000</span></p>
                <canvas id="pie-bev">                    
                </canvas>
            </div>
            <div class="col-3 text-center">
                <p>dish incomes:<span id="dish-income">10,000</span></p>
                <canvas id="pie-dish">                    
                </canvas>
            </div>
            <div class="col-3 text-center">
                <p>snack incomes:<span id="snack-income">10,000</span></p>
                <canvas id="pie-snack">                    
                </canvas>
            </div>
        </div>  

        <div class="dropdown-divider mt-4"></div>
        <!--ranking and timing-->
        <div class="row mt-3 mx-3">
            <div class="col-2">
                <p>Top 10 menu ranking:</p>
                <div id="menu-ranking">
                    <ul class="list-group">
                        <li class="list-group-item">1. First item</li>
                        <li class="list-group-item">2. Second item</li>
                        <li class="list-group-item">3. Third item</li>
                        <li class="list-group-item">4. First item</li>
                        <li class="list-group-item">5. Second item</li>
                        <li class="list-group-item">6. Third item</li>
                        <li class="list-group-item">7. First item</li>
                        <li class="list-group-item">8. Second item</li>
                        <li class="list-group-item">9. Third item</li>
                        <li class="list-group-item">10. Third item</li>
                      </ul>
                </div>
            </div>
            <div class="col-9">
                <p>order - time:</p>
                <canvas id="line-time" width="400" height="150" role="img">                    
                </canvas>
            </div>
            <div class="col-1 text-secondary text-right">   
                <br><br>             
                <p>peak-time</p>
                <p class="text-primary" id="peak-time">~06.00</p>                
            </div>
        </div>                 
    </div>
    <script>
        checkToken(sessionStorage.wbUsr, sessionStorage.wbToken);
        $('#navbar-main').load("../components/navbar-main/navbar-main.html #navbar-main");
        $.getScript("../components/navbar-main/navbar-main.js");

        var t_days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thur', 'Fri', 'Sat'];
        var t_n = new Date();
        var t_y = t_n.getFullYear();
        var t_m = t_n.getMonth() + 1;
        var t_d = t_n.getDate();
        var t_ds = t_n.getDay();
        var current_date = `${t_y}-${String("0" + t_m).slice(-2)}-${t_d}`;
        var metaGlobal = [];
        document.getElementById("current-date").innerHTML = t_days[t_ds] + " " + String("0" + t_m).slice(-2) + "/" + t_d + "/" + t_y;
        //-------------------------  
        $(document).ready(function () {
                $.ajax({
                    url: `/wb-app-03/ajax/service/reportService/reportService.php?date=${t_y + '-' + String("0" + t_m).slice(-2) + '-' + String("0" + t_d).slice(-2)}`,
                    type: "GET",
                    beforeSend: function () {
                        console.log("request data...");
                    },
                    success: function (result) {
                        if (result != "0") {                                                     
                            //------cal dataset for each chart--------
                            var resJson = JSON.parse(result);
                            console.log(resJson);                                                        
                            //------cal meta data---------------------
                            //--incomes                            
                            let bevIncome = 0;
                            let dishIncome = 0;
                            let snackIncome = 0;
                            let bevType = [];
                            let dishType = [];
                            let snackType = [];
                            let bevAmount = 0;
                            let dishAmount = 0;
                            let snackAmount = 0;                            
                            resJson.forEach(el => {                                
                                switch (el.itemType) {
                                    case "1":   
                                    bevIncome += parseInt(el.cost) * parseInt(el.unit);  
                                    bevAmount += parseInt(el.unit);
                                    if(!bevType.includes(el.itemName)){
                                        bevType.push(el.itemName);                                        
                                    }                         
                                        break;
                                    case "2":       
                                    dishAmount += parseInt(el.unit); 
                                    dishIncome += parseInt(el.cost) * parseInt(el.unit);  
                                    if(!dishType.includes(el.itemName)){
                                        dishType.push(el.itemName);
                                    }                               
                                        break;
                                    case "3":   
                                    snackAmount += parseInt(el.unit);
                                    if(!snackType.includes(el.itemName)){
                                        snackType.push(el.itemName);
                                    }   
                                    snackIncome += parseInt(el.cost) * parseInt(el.unit);                                    
                                        break;
                                    default:
                                        break;
                                }                                
                            });
                            metaGlobal = {
                                "bevIncome" : bevIncome,
                                "dishIncome" : dishIncome,
                                "snackIncome" : snackIncome,
                                "totalIncome" : bevIncome + dishIncome + snackIncome,  
                                "bevType" : bevType,
                                "dishType" : dishType,
                                "snackType" : snackType,
                                "bevAmount" : bevAmount,
                                "dishAmount" : dishAmount,
                                "snackAmount" : snackAmount                              
                            };                                                                                                      
                            console.log(metaGlobal);
                            //----------------------------------------
                            //----------------------------------------
                            //--summary-pie-chart--
                            var ctx = document.getElementById('pie-summary').getContext('2d');
                            var sumPieChart = new Chart(ctx, {
                                // The type of chart we want to create
                                type: 'pie',

                                // The data for our dataset
                                data: {
                                    labels: ['bev', 'dish', 'snack'],
                                    datasets: [{
                                        label: 'My First dataset',
                                        backgroundColor: ['rgb(75,134,180)', 'rgb(173,203,227)', 'rgb(231,239,246)'],
                                        borderColor: 'rgb(42,77,105)',
                                        data: [metaGlobal.bevAmount, metaGlobal.dishAmount, metaGlobal.snackAmount]
                                    }]
                                },

                                // Configuration options go here
                                options: {
                                    legend: {
                                        position: 'right'
                                    }
                                }
                            });
                            document.getElementById("total-income").innerHTML = metaGlobal.totalIncome;

                            //--beverage-pie-chart--
                            let bevPieLabels = metaGlobal.bevType;
                            let bevPieDataset = [];
                            resJson.forEach(el => {                                
                                if(bevPieDataset[bevPieLabels.indexOf(el.itemName)] == null){
                                    bevPieDataset[bevPieLabels.indexOf(el.itemName)] = parseInt(el.unit);
                                }else{
                                    bevPieDataset[bevPieLabels.indexOf(el.itemName)] += parseInt(el.unit);
                                }
                            });
                            ctx = document.getElementById('pie-bev').getContext('2d');
                            var bevPieChart = new Chart(ctx, {
                                // The type of chart we want to create
                                type: 'doughnut',

                                // The data for our dataset
                                data: {
                                    labels: bevPieLabels,                                    
                                    datasets: [{
                                        label: 'My First dataset',                                        
                                        borderColor: 'rgb(42,77,105)',
                                        backgroundColor: ['#F5F5F5','#E0E0E0','#BDBDBD','#9E9E9E','#ECEFF1','#CFD8DC','#B0BEC5','#90A4AE'],
                                        data: bevPieDataset
                                    }]                                    
                                },

                                // Configuration options go here
                                options: {
                                    legend: {
                                        display: false
                                    }
                                }
                            });
                            document.getElementById("bev-income").innerHTML = metaGlobal.bevIncome;

                            //--dishes-pie-chart--
                            let dishPieLabels = metaGlobal.dishType;
                            let dishPieDataset = [];
                            resJson.forEach(el => {                                
                                if(dishPieDataset[dishPieLabels.indexOf(el.itemName)] == null){
                                    dishPieDataset[dishPieLabels.indexOf(el.itemName)] = parseInt(el.unit);
                                }else{
                                    dishPieDataset[dishPieLabels.indexOf(el.itemName)] += parseInt(el.unit);
                                }
                            });
                            console.log(dishPieDataset);
                            ctx = document.getElementById('pie-dish').getContext('2d');
                            var dishPieChart = new Chart(ctx, {
                                // The type of chart we want to create
                                type: 'doughnut',

                                // The data for our dataset
                                data: {
                                    labels: dishPieLabels,
                                    datasets: [{
                                        label: 'My First dataset',
                                        borderColor: 'rgb(42,77,105)',
                                        backgroundColor: ['#F5F5F5','#E0E0E0','#BDBDBD','#9E9E9E','#ECEFF1','#CFD8DC','#B0BEC5','#90A4AE'],
                                        data: dishPieDataset
                                    }]
                                },

                                // Configuration options go here
                                options: {
                                    legend: {
                                        display: false
                                    }
                                }
                            });
                            document.getElementById("dish-income").innerHTML = metaGlobal.dishIncome;

                            //--snack-pie-chart--
                            let snackPieLabels = metaGlobal.snackType;
                            let snackPieDataset = [];
                            resJson.forEach(el => {                                
                                if(snackPieDataset[snackPieLabels.indexOf(el.itemName)] == null){
                                    snackPieDataset[snackPieLabels.indexOf(el.itemName)] = parseInt(el.unit);
                                }else{
                                    snackPieDataset[snackPieLabels.indexOf(el.itemName)] += parseInt(el.unit);
                                }
                            });
                            console.log(snackPieDataset);
                            ctx = document.getElementById('pie-snack').getContext('2d');
                            var snackPieChart = new Chart(ctx, {
                                // The type of chart we want to create
                                type: 'doughnut',

                                // The data for our dataset
                                data: {
                                    labels: snackPieLabels,
                                    datasets: [{
                                        label: 'My First dataset',
                                        borderColor: 'rgb(42,77,105)',
                                        backgroundColor: ['#F5F5F5','#E0E0E0','#BDBDBD','#9E9E9E','#ECEFF1','#CFD8DC','#B0BEC5','#90A4AE'],
                                        data: snackPieDataset
                                    }]
                                },

                                // Configuration options go here
                                options: {
                                    legend: {
                                        display: false
                                    }
                                }
                            });
                            document.getElementById("snack-income").innerHTML = metaGlobal.snackIncome;
                            
                            //--ranking----------                                                 
                            let allItemType = metaGlobal.bevType.concat(metaGlobal.dishType.concat(metaGlobal.snackType));
                            let allItemAmount = bevPieDataset.concat(dishPieDataset.concat(snackPieDataset));
                            let tmpAllItemAmount = String(allItemAmount);
                            let tmp = [];
                            let ranked = [];
                            tmpAllItemAmount = tmpAllItemAmount.split(",");
                            tmpAllItemAmount.sort().reverse();  
                            tmpAllItemAmount.forEach(el => {
                                if(!tmp.includes(parseInt(el))){
                                    tmp.push(parseInt(el));
                                }
                            });  
                            for (let i = 0; i < tmp.length; i++) {                                                         
                                for (let j = 0; j < allItemType.length; j++) {                                                                       
                                    if(allItemAmount[j] == tmp[i])
                                        ranked.push(`#${i+1}:${allItemType[j]}`);
                                }
                            }  
                            ranked = ranked.slice(0,10);      
                            //-show 10 rank-
                            let ul = document.createElement("UL");
                            ul.classList.add("list-group");
                            for (let i = 0; i < ranked.length; i++) {                                
                                let li = document.createElement("LI");
                                li.innerText = ranked[i];
                                li.classList.add("list-group-item");
                                ul.appendChild(li);
                            }
                            document.getElementById("menu-ranking").innerHTML = "";
                            document.getElementById("menu-ranking").appendChild(ul);
                           

                            //--time-line-chart--
                            
                            let timeChartRes = JSON.parse(result);
                            let checkTime = ['06:00', '06:30', '07:00', '07:30', '8:00', '8:30', '9:00', '9:30', '10:00', '10:30', '11:00', '11:30', '12:00', '12:30', '13:00','13:30', '14:00', '14:30', '15:00', '15:30', '16:00', '16:30', '17:00', '17:30', '18:00', '18:30', '19:00', '19:30', '20:00'];
                            let timeChartDataset = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];//6.00-20.00
                            let curHour = new Date();
                            curHour = curHour.getHours();//check from 6.00 -> curHour                            
                            timeChartRes.forEach(el => {
                                let tmpTime = el.addDate;
                                tmpTime = tmpTime.split(" ");
                                tmpTime = tmpTime[1];
                                tmpTime = tmpTime.slice(0,-3);
                                el.addDate = tmpTime;                                
                            });                                                           
                            for (let i = 0; i < checkTime.length; i++) {    //checkTime                                                           
                                for (let j = 0; j < timeChartRes.length; j++) {   //timeChartRes
                                    if(checkTime[i] <= timeChartRes[j].addDate && timeChartRes[j].addDate < checkTime[i+1]){                                        
                                        timeChartDataset[i] += parseInt(timeChartRes[j].unit);
                                    }                      
                                }                                
                            }
                            document.getElementById("peak-time").innerHTML = `~${checkTime[timeChartDataset.indexOf(Math.max.apply(Math, timeChartDataset))]}`;
                            ctx = document.getElementById('line-time').getContext('2d');
                            var timeLineChart = new Chart(ctx, {
                                // The type of chart we want to create
                                type: 'line',

                                // The data for our dataset
                                data: {
                                    labels: checkTime,
                                    datasets: [{
                                        backgroundColor: ['rgb(255, 255, 255)'],
                                        borderColor: 'rgb(4,123,255)',
                                        data: timeChartDataset
                                    }]
                                },

                                // Configuration options go here
                                options: {
                                    legend: {
                                        display: false
                                    }
                                }
                            });
                        } else {
                            console.log("Error");
                        }                        
                    }                    
                });

            });
        //-------------------------                  
    </script>
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="../assets/bootstrap/js/bootstrap.js" crossorigin="anonymous"></script>
</body>

</html>